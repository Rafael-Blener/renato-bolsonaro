<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Lideran√ßas - V16 (Boa Esperan√ßa)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        #map { height: 100vh; width: 100%; z-index: 0; }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background-color: white; color: #333; box-shadow: 0 3px 14px rgba(0,0,0,0.4); }
        .leaflet-popup-content p { margin: 0.5em 0; }
        .transition-opacity { transition: opacity 0.3s ease-in-out; }
        
        .map-title-text { font-size: clamp(1.25rem, 3vw, 2.25rem); }

        .search-wrapper { position: absolute; top: 20px; left: 60px; z-index: 1000; width: 300px; display: flex; flex-direction: column; gap: 10px; }
        .agenda-wrapper { position: absolute; top: 130px; left: 60px; z-index: 1000; width: 300px; max-height: 400px; overflow-y: auto; }
        
        .view-toggle { position: absolute; top: 20px; right: 280px; z-index: 1000; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); display: flex; gap: 5px; }
        .toggle-btn { padding: 8px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; cursor: pointer; transition: all 0.2s; text-transform: uppercase; }
        .toggle-active { color: white; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }

        .search-box { background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); display: flex; align-items: center; padding: 5px 10px; }
        
        .backup-controls { position: absolute; bottom: 20px; left: 20px; z-index: 1000; display: flex; gap: 10px; }
        .btn-backup { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.3); cursor: pointer; transition: transform 0.2s; }
        .btn-backup:hover { transform: scale(1.1); }

        @media (max-width: 640px) {
            .search-wrapper { top: 80px; left: 50%; transform: translateX(-50%); width: 90%; }
            .agenda-wrapper { top: 190px; left: 50%; transform: translateX(-50%); width: 90%; }
            .view-toggle { top: auto; bottom: 100px; right: 50%; transform: translateX(50%); width: 90%; justify-content: center; }
            .backup-controls { bottom: 90px; left: 20px; flex-direction: column; }
        }
    </style>
</head>
<body class="font-sans bg-gray-100">

    <div id="app-content">
        
        <div class="backup-controls">
            <button onclick="baixarBackup()" class="btn-backup bg-gray-700 hover:bg-gray-800" title="BAIXAR DADOS (Salvar no computador)">
                <i class="fas fa-download"></i>
            </button>
            <button onclick="document.getElementById('input-restore').click()" class="btn-backup bg-orange-600 hover:bg-orange-700" title="RESTAURAR DADOS (Carregar arquivo)">
                <i class="fas fa-upload"></i>
            </button>
            <input type="file" id="input-restore" class="hidden" accept=".json" onchange="restaurarBackup(this)">
        </div>

        <div class="view-toggle">
            <button id="btn-view-votos" class="toggle-btn bg-blue-600 text-white toggle-active" onclick="mudarModoVisualizacao('votos')"><i class="fas fa-chart-pie"></i> Eleitoral</button>
            <button id="btn-view-radar" class="toggle-btn bg-gray-200 text-gray-600" onclick="mudarModoVisualizacao('radar')"><i class="fas fa-satellite-dish"></i> Radar</button>
        </div>

        <div class="search-wrapper">
            <div class="search-box border-l-4 border-green-500">
                <input type="text" id="search-db-input" placeholder="Buscar lideran√ßas..." class="w-full bg-transparent border-none focus:ring-0 text-sm py-2 px-2 outline-none">
                <button id="search-db-btn" class="text-green-600 p-2"><i class="fas fa-users"></i></button>
            </div>
            <div class="search-box border-l-4 border-blue-500">
                <input type="text" id="search-global-input" placeholder="Localizar em SP..." class="w-full bg-transparent border-none focus:ring-0 text-sm py-2 px-2 outline-none">
                <button id="search-global-btn" class="text-blue-600 p-2"><i class="fas fa-map-marker-alt"></i></button>
            </div>
            <p id="search-status-msg" class="text-xs text-red-600 bg-white px-2 rounded hidden"></p>
        </div>

        <div id="agenda-panel" class="agenda-wrapper bg-white rounded-lg shadow-lg p-3 hidden">
            <h4 class="text-xs font-bold text-gray-500 uppercase mb-2 border-b pb-1">Agenda Imediata</h4>
            <div id="agenda-content" class="space-y-2"></div>
        </div>

        <div id="map"></div>

        <div class="fixed top-4 left-1/2 -translate-x-1/2 bg-white bg-opacity-80 py-2 px-6 rounded-lg shadow-lg z-10 pointer-events-none w-11/12 max-w-md md:max-w-lg">
            <h1 class="map-title-text text-gray-800 font-bold text-center uppercase">Mapa Lideran√ßas</h1>
        </div>

        <div id="placar-geral-caixa" class="fixed top-4 right-4 bg-white p-3 rounded-lg shadow-lg z-10 w-60 hidden md:block">
            <div class="mb-4">
                <div class="flex justify-between items-end mb-1"><span class="text-xs font-bold text-gray-500 uppercase">Cobertura SP</span><span id="progresso-porcentagem" class="text-xs font-bold text-blue-600">0%</span></div>
                <div class="w-full bg-gray-200 rounded-full h-2.5"><div id="barra-progresso" class="bg-blue-600 h-2.5 rounded-full transition-all duration-1000" style="width: 0%"></div></div>
                <p id="progresso-texto" class="text-xs text-center mt-1 text-gray-600 font-semibold">0 de 645 Munic√≠pios</p>
            </div>
            <div class="border-t my-2"></div>
            <h3 class="text-sm font-bold text-gray-800">Votos Conquistados</h3>
            <p id="total-votos-valor" class="text-xl font-bold text-green-600 text-center">0</p>
            <div class="border-t my-2"></div>
            <h4 class="text-sm font-bold text-gray-800 mb-1">Top L√≠deres</h4>
            <ol id="ranking-lideres-lista" class="list-decimal list-inside space-y-1 text-xs text-gray-600"></ol>
        </div>

        <button id="add-lider-btn-principal" class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-4 shadow-lg z-10" title="Adicionar Nova Lideran√ßa"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg></button>
        
        <div id="add-lider-modal-principal" class="fixed inset-0 bg-black bg-opacity-50 z-20 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Cadastrar Nova Lideran√ßa</h2>
                <div class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700">Munic√≠pio</label><div class="flex items-center space-x-2 mt-1"><input type="text" id="municipioInputPrincipal" class="block w-full px-3 py-2 border rounded-md" placeholder="Ex: Santos"><button id="geocode-btn-principal" class="px-4 py-2 bg-gray-600 text-white rounded-md">Buscar</button></div><p id="geocode-status-principal" class="text-xs text-gray-500 mt-1 h-4"></p><input type="hidden" id="latInputPrincipal"><input type="hidden" id="lonInputPrincipal"></div>
                    <div class="border-t pt-4"><label class="block text-sm font-medium text-gray-700">Nome do L√≠der</label><input type="text" id="novoNomeInputPrincipal" class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Votos</label><input type="number" id="novoVotosInputPrincipal" class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Contato</label><input type="text" id="novoContatoInputPrincipal" class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3"><button id="cancel-lider-principal-btn" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button><button id="save-lider-principal-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md">Salvar Lideran√ßa</button></div>
            </div>
        </div>

        <div id="manage-lideres-modal" class="fixed inset-0 bg-black bg-opacity-50 z-30 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <h2 class="text-2xl font-bold mb-2 text-gray-800">Gerenciar: <span id="manage-modal-title" class="text-blue-600"></span></h2>
                <div class="bg-blue-50 p-4 rounded-md mb-4 border border-blue-200">
                    <h3 class="text-sm font-bold text-blue-800 mb-2 uppercase"><i class="far fa-calendar-alt"></i> Controle de Visita</h3>
                    <div class="flex items-center gap-3"><div class="flex-grow"><label class="block text-xs text-gray-600">Data da Visita</label><input type="date" id="data-visita-input" class="mt-1 block w-full px-3 py-2 border rounded-md text-sm"></div></div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-md mb-4 border border-yellow-200">
                    <h3 class="text-sm font-bold text-yellow-800 mb-2 uppercase"><i class="fas fa-book"></i> Caderno de Campo</h3>
                    <textarea id="notas-estrategicas" rows="3" class="w-full p-2 text-sm border rounded-md outline-none" placeholder="Anota√ß√µes estrat√©gicas..."></textarea>
                    <button id="save-info-btn" class="mt-2 w-full px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-md text-sm">Salvar Informa√ß√µes</button>
                </div>
                <div id="lideres-list" class="space-y-3 mb-6 pr-2"></div>
                <div class="border-t pt-4">
                    <h3 class="text-sm font-bold text-gray-700 mb-2 uppercase">Adicionar Novo L√≠der</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3"><input type="text" id="add-lider-nome" placeholder="Nome" class="block w-full px-3 py-2 border rounded-md text-sm"><input type="number" id="add-lider-votos" placeholder="Votos" class="block w-full px-3 py-2 border rounded-md text-sm"><input type="text" id="add-lider-contato" placeholder="Contato" class="block w-full px-3 py-2 border rounded-md text-sm"></div>
                     <button id="save-new-lider-btn" class="mt-3 w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-md text-sm">Adicionar √† Lista</button>
                </div>
                <div class="mt-4 flex justify-end"><button id="close-manage-modal-btn" class="px-4 py-2 bg-gray-200 rounded-md">Fechar</button></div>
            </div>
        </div>
    </div>

    <script>
        let modoVisualizacao = 'votos';
        let map;
        let mapLayers = {};
        let municipioEmGerenciamento = null;
        
        const BASE_LAT = -24.2819; 
        const BASE_LON = -47.4606;
        const TOTAL_MUNICIPIOS_SP = 645;
        // ATUALIZADO PARA V16 (COM BOA ESPERAN√áA DO SUL)
        const DADOS_VOTOS_KEY = 'mapaBolsonaroDados_v16'; 

        document.addEventListener('DOMContentLoaded', () => { iniciarAplicacao(); });

        function iniciarAplicacao() {
            map = L.map('map').setView([-22.5, -48.0], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
            inicializarDados();
            redesenharMapaCompleto();
            atualizarPlacarGeral(); 
            atualizarPainelAgenda();
        }

        window.baixarBackup = () => {
            const dados = localStorage.getItem(DADOS_VOTOS_KEY);
            if (!dados) { alert("Sem dados para salvar."); return; }
            const blob = new Blob([dados], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const dataHoje = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = `backup_liderancas_${dataHoje}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        window.restaurarBackup = (input) => {
            const arquivo = input.files[0];
            if (!arquivo) return;
            const leitor = new FileReader();
            leitor.onload = function(e) {
                try {
                    const conteudo = e.target.result;
                    JSON.parse(conteudo); 
                    if(confirm("ATEN√á√ÉO: Isso vai substituir os dados atuais pelos do arquivo. Tem certeza?")) {
                        localStorage.setItem(DADOS_VOTOS_KEY, conteudo);
                        alert("Dados restaurados com sucesso!");
                        location.reload(); 
                    }
                } catch (erro) { alert("Erro: Arquivo inv√°lido."); }
            };
            leitor.readAsText(arquivo);
            input.value = ''; 
        };

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c;
        }
        function deg2rad(deg) { return deg * (Math.PI/180) }

        window.mudarModoVisualizacao = (modo) => {
            modoVisualizacao = modo;
            const btnVotos = document.getElementById('btn-view-votos');
            const btnRadar = document.getElementById('btn-view-radar');
            if(modo === 'votos') {
                btnVotos.className = "toggle-btn bg-blue-600 text-white toggle-active";
                btnRadar.className = "toggle-btn bg-gray-200 text-gray-600";
            } else {
                btnVotos.className = "toggle-btn bg-gray-200 text-gray-600";
                btnRadar.className = "toggle-btn bg-red-600 text-white toggle-active";
            }
            redesenharMapaCompleto();
        };
        
        function inicializarDados() {
            const dadosSalvos = localStorage.getItem(DADOS_VOTOS_KEY);
            if (!dadosSalvos) { 
                const dadosIniciais = {
                    "Amparo": { lat: -22.70, lon: -46.76, lideres: [{ id: 1, nome: "Paulo Rossi", telefone: "N√£o informado", votos: 36478 }] },
                    "Avar√©": { lat: -23.09, lon: -48.92, lideres: [{ id: 2, nome: "Prefeito", telefone: "N√£o informado", votos: 41468 }] },
                    "Bauru": { lat: -22.31, lon: -49.06, lideres: [{ id: 3, nome: "(Sem l√≠der informado)", telefone: "N√£o informado", votos: 169278 }] },
                    "Bertioga": { lat: -23.85, lon: -46.13, lideres: [{ id: 4, nome: "(Sem l√≠der informado)", telefone: "N√£o informado", votos: 36318 }] },
                    "Boa Esperan√ßa do Sul": { lat: -21.9932, lon: -48.3905, lideres: [{ id: 48, nome: "Felipe Miracatu", telefone: "N√£o informado", votos: 6829 }] },
                    "Boituva": { lat: -23.28, lon: -47.67, lideres: [{ id: 5, nome: "(Sem l√≠der informado)", telefone: "N√£o informado", votos: 31878 }] },
                    "Bragan√ßa Paulista": { lat: -22.95, lon: -46.54, lideres: [{ id: 6, nome: "Cel. Am√©rico", telefone: "N√£o informado", votos: 88068 }] },
                    "Caraguatatuba": { lat: -23.62, lon: -45.41, lideres: [{ id: 7, nome: "(Sem l√≠der informado)", telefone: "N√£o informado", votos: 73388 }] },
                    "Ces√°rio Lange": { lat: -23.22, lon: -47.95, lideres: [{ id: 8, nome: "(Sem l√≠der informado)", telefone: "N√£o informado", votos: 9938 }] },
                    "Franca": { lat: -20.53, lon: -47.40, lideres: [{ id: 9, nome: "Jarbas Guarulhos e Ver. Fran S√©rgio", telefone: "N√£o informado", votos: 141299 }] },
                    "Ibitinga": { lat: -21.75, lon: -48.82, lideres: [{ id: 10, nome: "Janaina", telefone: "N√£o informado", votos: 27856 }] },
                    "Ilhabela": { lat: -23.77, lon: -45.35, lideres: [{ id: 11, nome: "(Sem l√≠der informado)", telefone: "N√£o informado", votos: 23356 }] },
                    "Indaiatuba": { lat: -23.09, lon: -47.21, lideres: [{ id: 12, nome: "(Sem l√≠der informado)", telefone: "N√£o informado", votos: 125473 }] },
                    "Itapecerica da Serra": { lat: -23.71, lon: -46.84, lideres: [{ id: 13, nome: "Sangue Bom; J√∫lio; Adeval; Celsin", telefone: "N√£o informado", votos: 87877 }] },
                    "Itapetininga": { lat: -23.59, lon: -48.05, lideres: [{ id: 14, nome: "Trad; Mauro; Danilo Ballas", telefone: "N√£o informado", votos: 77875 }] },
                    "Itu": { lat: -23.26, lon: -47.29, lideres: [{ id: 15, nome: "(Sem l√≠der informado)", telefone: "N√£o informado", votos: 82739 }] },
                    "Leme": { lat: -22.18, lon: -47.38, lideres: [{ id: 16, nome: "Ver. Andrea Mondin, Ribas", telefone: "N√£o informado", votos: 48878 }] },
                    "Lins": { lat: -21.67, lon: -49.75, lideres: [{ id: 17, nome: "Ieda; Carlos Hon√≥rio; Marco Borsonaro", telefone: "N√£o informado", votos: 36085 }] },
                    "Mogi Gua√ßu": { lat: -22.37, lon: -46.94, lideres: [{ id: 18, nome: "Polentini", telefone: "N√£o informado", votos: 77224 }] },
                    "Mombuca": { lat: -22.92, lon: -47.56, lideres: [{ id: 19, nome: "Vereador Linguinha", telefone: "N√£o informado", votos: 2572 }] },
                    "Morro Agudo": { lat: -20.73, lon: -48.05, lideres: [{ id: 20, nome: "Amarelinho", telefone: "N√£o informado", votos: 14273 }] },
                    "Ol√≠mpia": { lat: -20.73, lon: -48.91, lideres: [{ id: 21, nome: "Tarc√≠sio", telefone: "N√£o informado", votos: 29899 }] },
                    "Panorama": { lat: -21.35, lon: -51.85, lideres: [{ id: 23, nome: "Eneas", telefone: "N√£o informado", votos: 7770 }] },
                    "Promiss√£o": { lat: -21.53, lon: -49.86, lideres: [{ id: 25, nome: "Ieda; Carlos Hon√≥rio; Marco Borsonaro", telefone: "N√£o informado", votos: 18633 }] },
                    "Santos": { lat: -23.96, lon: -46.33, lideres: [{ id: 29, nome: "Piru", telefone: "N√£o informado", votos: 222154 }] },
                    "S√£o Sebasti√£o": { lat: -23.76, lon: -45.40, lideres: [{ id: 30, nome: "(Sem l√≠der informado)", telefone: "N√£o informado", votos: 51303 }] },
                    "Taubat√©": { lat: -23.02, lon: -45.55, lideres: [{ id: 31, nome: "Rog√©rio Silva", telefone: "N√£o informado", votos: 157218 }] },
                    "Ubatuba": { lat: -23.43, lon: -45.07, lideres: [{ id: 32, nome: "(Sem l√≠der informado)", telefone: "N√£o informado", votos: 52682 }] },
                    "Valinhos": { lat: -22.96, lon: -46.99, lideres: [{ id: 33, nome: "Ver. Rafa e Ver. D√©bora", telefone: "N√£o informado", votos: 63531 }] },
                    "Pirassununga": { lat: -21.99, lon: -47.43, lideres: [{ id: 34, nome: "Danilo | Ex assessor Frias", telefone: "N√£o informado", votos: 36506 }] },
                    "Bady Bassitt": { lat: -20.91, lon: -49.44, lideres: [{ id: 36, nome: "Adriano Menesses", telefone: "N√£o informado", votos: 11397 }] },
                    "Itatiba": { lat: -23.00, lon: -46.84, lideres: [{ id: 37, nome: "Adriana", telefone: "N√£o informado", votos: 58437 }] },
                    "Campinas": { lat: -22.90, lon: -47.06, lideres: [{ id: 38, nome: "Almo√ßo c√≠rculo militar - Nilce", telefone: "N√£o informado", votos: 533188 }] },
                    "Presidente Prudente": { lat: -22.12, lon: -51.38, lideres: [{ id: 39, nome: "(Sem l√≠der informado)", telefone: "N√£o informado", votos: 109077 }] },
                    "Piracicaba": { lat: -22.72, lon: -47.64, lideres: [{ id: 24, nome: "Jarbas Guarulhos", telefone: "N√£o informado", votos: 198468 }] },
                    "Palmeira d'Oeste": { lat: -20.16, lon: -50.81, lideres: [{ id: 22, nome: "Prefeito Valdir; Serginho Vilson; Dep. Ricardo Izar", telefone: "N√£o informado", votos: 5537 }] },
                    "Rio das Pedras": { lat: -22.84, lon: -47.60, lideres: [{ id: 26, nome: "Prefeito / Ver. Paulo Campos; Jarbas Guarulhos", telefone: "N√£o informado", votos: 19034 }] },
                    "Santa F√© do Sul": { lat: -20.21, lon: -50.92, lideres: [{ id: 27, nome: "Carlos Anittrto; Til√°pias; Ver. Murilo Bazi; Serginho Vilson; Dep. Ricardo Izar", telefone: "N√£o informado", votos: 35237 }] },
                    "Capivari": { lat: -22.99, lon: -47.51, lideres: [{ id: 35, nome: "Jaiminho (Sumar√©)", telefone: "N√£o informado", votos: 26919 }] },
                    "Anhembi": { lat: -22.7981, lon: -48.1311, lideres: [{ id: 40, nome: "Jarbas Guarulhos", telefone: "N√£o informado", votos: 4455 }] },
                    "Cerquilho": { lat: -23.1672, lon: -47.7447, lideres: [{ id: 41, nome: "Jarbas Guarulhos", telefone: "N√£o informado", votos: 24465 }] },
                    "Guarani d'Oeste": { lat: -20.0766, lon: -50.3377, lideres: [{ id: 42, nome: "Serginho Vilson; Dep. Ricardo Izar", telefone: "N√£o informado", votos: 1643 }] },
                    "Nova Cana√£ Paulista": { lat: -20.3638, lon: -50.9452, lideres: [{ id: 43, nome: "Serginho Vilson; Dep. Ricardo Izar", telefone: "N√£o informado", votos: 2080 }] },
                    "Rubineia": { lat: -20.1794, lon: -51.0083, lideres: [{ id: 44, nome: "Serginho Vilson; Dep. Ricardo Izar", telefone: "N√£o informado", votos: 3208 }] },
                    "Santa Clara d'Oeste": { lat: -20.0886, lon: -50.9338, lideres: [{ id: 45, nome: "Serginho Vilson; Dep. Ricardo Izar", telefone: "N√£o informado", votos: 2092 }] },
                    "Santa Rita d'Oeste": { lat: -20.1261, lon: -50.8588, lideres: [{ id: 46, nome: "Serginho Vilson; Dep. Ricardo Izar", telefone: "N√£o informado", votos: 2154 }] },
                    "Tr√™s Fronteiras": { lat: -20.2336, lon: -50.8872, lideres: [{ id: 47, nome: "Serginho Vilson; Dep. Ricardo Izar", telefone: "N√£o informado", votos: 4047 }] }
                };
                localStorage.setItem(DADOS_VOTOS_KEY, JSON.stringify(dadosIniciais));
            }
        }

        function carregarTodosDados() { return JSON.parse(localStorage.getItem(DADOS_VOTOS_KEY) || '{}'); }
        function salvarTodosDados(dados) { localStorage.setItem(DADOS_VOTOS_KEY, JSON.stringify(dados)); }
        function carregarDadosMunicipio(municipioNome) { return carregarTodosDados()[municipioNome] || { lat: 0, lon: 0, lideres: [], dataVisita: null, notas: '' }; }
        function calcularVotosTotaisMunicipio(dadosMunicipio) { return dadosMunicipio.lideres.reduce((acc, lider) => acc + (parseInt(lider.votos, 10) || 0), 0); }

        function atualizarPainelAgenda() {
            const todosDados = carregarTodosDados();
            const hoje = new Date();
            hoje.setHours(0,0,0,0);
            const limite7Dias = new Date(hoje);
            limite7Dias.setDate(hoje.getDate() + 7);
            let agendaHoje = [];
            let agenda7Dias = [];
            for (const [nome, dados] of Object.entries(todosDados)) {
                if (dados.dataVisita) {
                    const visitaData = new Date(dados.dataVisita + 'T12:00:00');
                    visitaData.setHours(0,0,0,0);
                    if (visitaData.getTime() === hoje.getTime()) agendaHoje.push(nome);
                    else if (visitaData > hoje && visitaData <= limite7Dias) agenda7Dias.push({ nome: nome, data: visitaData });
                }
            }
            agenda7Dias.sort((a, b) => a.data - b.data);
            const painelEl = document.getElementById('agenda-panel');
            const contentEl = document.getElementById('agenda-content');
            contentEl.innerHTML = '';
            let hasContent = false;
            if (agendaHoje.length > 0) {
                hasContent = true;
                agendaHoje.forEach(cidade => { contentEl.innerHTML += `<div onclick="zoomToCity('${cidade}')" class="bg-red-100 border-l-4 border-red-500 p-2 cursor-pointer hover:bg-red-200 transition"><p class="text-xs font-bold text-red-700 uppercase animate-pulse">üö® VISITA HOJE:</p><p class="text-sm font-bold text-gray-800">${cidade}</p></div>`; });
            }
            if (agenda7Dias.length > 0) {
                hasContent = true;
                if(agendaHoje.length > 0) contentEl.innerHTML += `<div class="border-t my-1"></div>`;
                contentEl.innerHTML += `<p class="text-[10px] font-bold text-gray-500 uppercase mt-1">Pr√≥ximos 7 dias:</p>`;
                agenda7Dias.forEach(item => {
                    const dia = String(item.data.getDate()).padStart(2, '0');
                    const mes = String(item.data.getMonth() + 1).padStart(2, '0');
                    contentEl.innerHTML += `<div onclick="zoomToCity('${item.nome}')" class="flex justify-between items-center p-1 hover:bg-gray-100 rounded cursor-pointer border-b border-gray-100"><span class="text-sm text-gray-800">${item.nome}</span><span class="text-xs font-bold text-blue-600 bg-blue-50 px-1 rounded">${dia}/${mes}</span></div>`;
                });
            }
            if (hasContent) painelEl.classList.remove('hidden'); else painelEl.classList.add('hidden');
        }

        window.zoomToCity = (nome) => {
            const dados = carregarDadosMunicipio(nome);
            if(dados.lat) {
                map.setView([dados.lat, dados.lon], 12);
                if(mapLayers[nome]) mapLayers[nome].openPopup();
            }
        };

        function getStatusVisita(dataString) {
            if(!dataString) return { text: "Sem registro", color: "text-gray-500", icon: "‚ö™", code: 'null' };
            const hoje = new Date();
            hoje.setHours(0,0,0,0);
            const dataVisita = new Date(dataString + 'T12:00:00'); 
            if (dataVisita > hoje) return { text: `üìÖ Agendada: ${formatarData(dataString)}`, color: "text-blue-600 font-bold", icon: "üöÄ", code: 'future' };
            if (dataVisita.getTime() === hoje.getTime()) return { text: `üö® HOJE!`, color: "text-red-600 font-bold animate-pulse", icon: "üìç", code: 'today' };
            const diffDays = Math.ceil(Math.abs(hoje - dataVisita) / (1000 * 60 * 60 * 24)); 
            if (diffDays <= 90) return { text: `üî• Quente (${diffDays}d)`, color: "text-green-600", icon: "üî•", code: 'hot' };
            if (diffDays <= 180) return { text: `‚ö†Ô∏è Aten√ß√£o (${diffDays}d)`, color: "text-yellow-600", icon: "‚ö†Ô∏è", code: 'warm' };
            return { text: `‚ùÑÔ∏è Esfriando (+${diffDays}d)`, color: "text-red-500", icon: "‚ùÑÔ∏è", code: 'cold' };
        }
        function formatarData(dataISO) { const p = dataISO.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }

        function calcularRaio(votos) { return votos > 0 ? Math.sqrt(votos) * 24 : 0; }
        
        function getCorBolha(dados) {
            if (modoVisualizacao === 'votos') return { fill: '#7FFF00', border: '#FF0000' }; 
            const status = getStatusVisita(dados.dataVisita);
            switch(status.code) {
                case 'future': return { fill: '#3B82F6', border: '#1E40AF' }; 
                case 'today': return { fill: '#EF4444', border: '#991B1B' }; 
                case 'hot': return { fill: '#10B981', border: '#065F46' }; 
                case 'warm': return { fill: '#F59E0B', border: '#B45309' }; 
                case 'cold': return { fill: '#EF4444', border: '#7F1D1D' }; 
                default: return { fill: '#9CA3AF', border: '#4B5563' }; 
            }
        }

        function desenharCirculoNoMapa(municipioNome, dados) {
            if (mapLayers[municipioNome]) map.removeLayer(mapLayers[municipioNome]);
            const votosTotais = calcularVotosTotaisMunicipio(dados);
            const cores = getCorBolha(dados);
            const circle = L.circle([dados.lat, dados.lon], {
                color: cores.border, opacity: 1.0, weight: 1.5, fillColor: cores.fill, fillOpacity: 0.6, radius: calcularRaio(votosTotais)
            }).addTo(map);
            circle.bindPopup(() => criarConteudoPopup(municipioNome));
            mapLayers[municipioNome] = circle;
        }

        function redesenharMapaCompleto() {
            Object.values(mapLayers).forEach(layer => map.removeLayer(layer));
            const todosDados = carregarTodosDados();
            const municipiosOrdenados = Object.keys(todosDados).sort((a, b) => {
                const votosA = calcularVotosTotaisMunicipio(todosDados[a]);
                const votosB = calcularVotosTotaisMunicipio(todosDados[b]);
                return votosB - votosA; 
            });
            municipiosOrdenados.forEach(nomeMunicipio => { desenharCirculoNoMapa(nomeMunicipio, todosDados[nomeMunicipio]); });
        }

        function criarConteudoPopup(municipioNome) {
            const dados = carregarDadosMunicipio(municipioNome);
            const votosTotais = calcularVotosTotaisMunicipio(dados);
            const status = getStatusVisita(dados.dataVisita);
            const distanciaLinear = getDistanceFromLatLonInKm(BASE_LAT, BASE_LON, dados.lat, dados.lon);
            const distanciaCarroEst = Math.round(distanciaLinear * 1.35);

            let lideresHtml = dados.lideres.map(lider => `<div class="border-t mt-2 pt-2"><p><strong>L√≠der:</strong> ${lider.nome}</p><div class="flex items-center justify-between"><p><strong>Votos:</strong> ${(lider.votos || 0).toLocaleString('pt-BR')}</p></div></div>`).join('');
            if (dados.lideres.length === 0) lideresHtml = '<p>Nenhum l√≠der.</p>';

            const notasTexto = dados.notas ? `üìù *NOTAS:* ${dados.notas}\n` : '';
            const zapMsg = encodeURIComponent(`*RELAT√ìRIO: ${municipioNome.toUpperCase()}*\n\nüó≥ *Votos:* ${votosTotais.toLocaleString('pt-BR')}\nüìÖ *Status:* ${status.icon} ${status.text}\n${notasTexto}üöó *Dist√¢ncia:* ~${distanciaCarroEst}km\nüìç *Link:* https://maps.google.com/?q=${dados.lat},${dados.lon}`);

            return `<div class="p-1" style="max-width: 280px"><h3 class="text-lg font-bold text-gray-800">${municipioNome}</h3><p class="font-semibold text-blue-600">Total: ${votosTotais.toLocaleString('pt-BR')} votos</p><div class="mt-2 text-sm ${status.color} border border-gray-200 rounded p-1 text-center bg-gray-50">${status.icon} ${status.text}</div>${dados.notas ? `<div class="mt-2 bg-yellow-50 p-2 text-xs border border-yellow-200 rounded text-yellow-800 italic">üìù "${dados.notas}"</div>` : ''}<div class="bg-blue-50 p-2 rounded my-2 border border-blue-100 flex flex-col gap-1"><p class="text-xs text-gray-500 font-bold uppercase">Log√≠stica (de Miracatu)</p><p class="text-sm font-bold text-gray-700">~${distanciaCarroEst} km</p><div class="flex gap-1 mt-1"><a href="https://www.google.com/maps/dir/?api=1&origin=Miracatu,SP&destination=${dados.lat},${dados.lon}&travelmode=driving" target="_blank" class="flex-1 text-center bg-blue-600 hover:bg-blue-700 text-white text-[10px] font-bold py-1 px-1 rounded"><i class="fas fa-route"></i> GPS</a><a href="https://wa.me/?text=${zapMsg}" target="_blank" class="flex-1 text-center bg-green-500 hover:bg-green-600 text-white text-[10px] font-bold py-1 px-1 rounded"><i class="fab fa-whatsapp"></i> Reportar</a></div></div>${lideresHtml}<button onclick="abrirModalGerenciamento('${municipioNome}')" class="mt-3 w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-1 px-3 rounded text-xs">Gerenciar Agenda e L√≠deres</button></div>`;
        }

        document.getElementById('save-info-btn').addEventListener('click', () => {
            const dataInput = document.getElementById('data-visita-input').value;
            const notasInput = document.getElementById('notas-estrategicas').value;
            if (!municipioEmGerenciamento) return;
            const todosDados = carregarTodosDados();
            todosDados[municipioEmGerenciamento].dataVisita = dataInput; 
            todosDados[municipioEmGerenciamento].notas = notasInput;
            salvarTodosDados(todosDados);
            alert(`Informa√ß√µes salvas para ${municipioEmGerenciamento}!`);
            redesenharMapaCompleto(); 
            atualizarPainelAgenda();
        });

        function buscarMunicipioBase() {
            const termo = document.getElementById('search-db-input').value.trim().toLowerCase();
            const todosDados = carregarTodosDados();
            const removerAcentos = str => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const municipioEncontrado = Object.keys(todosDados).find(key => removerAcentos(key.toLowerCase()) === removerAcentos(termo));
            if (municipioEncontrado) {
                const dados = todosDados[municipioEncontrado];
                map.setView([dados.lat, dados.lon], 12);
                if (mapLayers[municipioEncontrado]) mapLayers[municipioEncontrado].openPopup();
            } else { alert("Munic√≠pio n√£o encontrado."); }
        }
        async function buscarCidadeGlobal() {
            const termo = document.getElementById('search-global-input').value.trim();
            if (!termo) return;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(termo)}, S√£o Paulo, Brasil`);
                const data = await response.json();
                if (data && data.length > 0) {
                    map.setView([data[0].lat, data[0].lon], 12);
                    L.marker([data[0].lat, data[0].lon]).addTo(map).bindPopup(`Localizado: ${termo}`).openPopup();
                } else { alert("N√£o encontrado."); }
            } catch (e) {}
        }
        document.getElementById('search-db-btn').addEventListener('click', buscarMunicipioBase);
        document.getElementById('search-global-btn').addEventListener('click', buscarCidadeGlobal);
        document.getElementById('search-db-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') buscarMunicipioBase(); });
        document.getElementById('search-global-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') buscarCidadeGlobal(); });

        window.abrirModalGerenciamento = (municipioNome) => {
            municipioEmGerenciamento = municipioNome;
            document.getElementById('manage-modal-title').textContent = municipioNome;
            const dados = carregarDadosMunicipio(municipioNome);
            document.getElementById('data-visita-input').value = dados.dataVisita || '';
            document.getElementById('notas-estrategicas').value = dados.notas || '';
            renderizarListaLideres(municipioNome);
            document.getElementById('manage-lideres-modal').classList.remove('hidden');
        };
        function renderizarListaLideres(municipioNome) {
            const dados = carregarDadosMunicipio(municipioNome);
            const listaEl = document.getElementById('lideres-list');
            listaEl.innerHTML = ''; 
            if (dados.lideres.length === 0) { listaEl.innerHTML = '<p class="text-gray-500 text-center">Nenhum l√≠der.</p>'; return; }
            dados.lideres.forEach(lider => {
                const item = document.createElement('div');
                item.className = 'bg-gray-100 p-3 rounded-md flex flex-wrap items-center justify-between';
                item.innerHTML = `<div class="flex-grow"><p class="font-semibold">${lider.nome}</p><p class="text-sm text-gray-600">Votos: ${(lider.votos || 0).toLocaleString('pt-BR')} | ${lider.telefone}</p></div><button onclick="removerLider('${municipioNome}', ${lider.id})" class="ml-4 px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs font-bold rounded">Remover</button>`;
                listaEl.appendChild(item);
            });
        }
        window.removerLider = (municipioNome, liderId) => {
            if (!confirm(`Tem certeza?`)) return;
            const todosDados = carregarTodosDados();
            todosDados[municipioNome].lideres = todosDados[municipioNome].lideres.filter(l => l.id !== liderId);
            salvarTodosDados(todosDados);
            renderizarListaLideres(municipioNome);
            redesenharMapaCompleto();
            atualizarPlacarGeral();
        };
        document.getElementById('close-manage-modal-btn').addEventListener('click', () => { document.getElementById('manage-lideres-modal').classList.add('hidden'); });
        
        document.getElementById('save-new-lider-btn').addEventListener('click', () => {
            const nome = document.getElementById('add-lider-nome').value.trim();
            const votos = parseInt(document.getElementById('add-lider-votos').value.trim(), 10);
            const telefone = document.getElementById('add-lider-contato').value.trim();
            if (!nome || isNaN(votos)) return;
            const todosDados = carregarTodosDados();
            todosDados[municipioEmGerenciamento].lideres.push({ id: Date.now(), nome, votos, telefone });
            salvarTodosDados(todosDados);
            const whatsappNumber = "5513996476655";
            const msg = encodeURIComponent(`CADASTRO DE NOVO LIDER\n\n*Munic√≠pio:* ${municipioEmGerenciamento}\n*L√≠der:* ${nome}\n*Votos:* ${votos}`);
            window.open(`https://wa.me/${whatsappNumber}?text=${msg}`, '_blank');
            renderizarListaLideres(municipioEmGerenciamento);
            redesenharMapaCompleto();
            atualizarPlacarGeral();
            document.getElementById('add-lider-nome').value = '';
            document.getElementById('add-lider-votos').value = '';
            document.getElementById('add-lider-contato').value = '';
        });

        function calcularTotalGeralDeVotos() { const d = carregarTodosDados(); let t = 0; for (const m in d) t += calcularVotosTotaisMunicipio(d[m]); return t; }
        function calcularTopLideres() { const d = carregarTodosDados(); const l = []; for (const m in d) d[m].lideres.forEach(x => l.push({...x, municipio: m})); return l.sort((a,b)=>b.votos-a.votos).slice(0,10); }
        function atualizarPlacarGeral() {
            const todosDados = carregarTodosDados();
            const total = calcularTotalGeralDeVotos();
            const totalCad = Object.keys(todosDados).length;
            const pct = (totalCad / TOTAL_MUNICIPIOS_SP) * 100;
            document.getElementById('total-votos-valor').textContent = total.toLocaleString('pt-BR');
            document.getElementById('progresso-texto').textContent = `${totalCad} de ${TOTAL_MUNICIPIOS_SP} Munic√≠pios`;
            document.getElementById('progresso-porcentagem').textContent = `${pct.toFixed(1)}%`;
            document.getElementById('barra-progresso').style.width = `${pct}%`;
            const top = calcularTopLideres();
            const lista = document.getElementById('ranking-lideres-lista');
            lista.innerHTML = '';
            top.forEach(l => { lista.innerHTML += `<li class="truncate"><span class="font-semibold">${l.nome}</span> (${(l.votos||0).toLocaleString('pt-BR')})<span class="block text-gray-400 text-[10px] -mt-0.5">${l.municipio}</span></li>` });
        }

        const addLiderModalPrincipal = document.getElementById('add-lider-modal-principal');
        document.getElementById('add-lider-btn-principal').addEventListener('click', () => addLiderModalPrincipal.classList.remove('hidden'));
        document.getElementById('cancel-lider-principal-btn').addEventListener('click', () => addLiderModalPrincipal.classList.add('hidden'));
        document.getElementById('geocode-btn-principal').addEventListener('click', async () => {
            const nome = document.getElementById('municipioInputPrincipal').value;
            try { const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(nome)}, Brasil`); const d = await r.json(); if(d.length>0) { document.getElementById('latInputPrincipal').value=d[0].lat; document.getElementById('lonInputPrincipal').value=d[0].lon; document.getElementById('geocode-status-principal').textContent="OK!"; } } catch(e){}
        });
        document.getElementById('save-lider-principal-btn').addEventListener('click', () => {
            const m = document.getElementById('municipioInputPrincipal').value.trim();
            const lat = parseFloat(document.getElementById('latInputPrincipal').value);
            const lon = parseFloat(document.getElementById('lonInputPrincipal').value);
            const n = document.getElementById('novoNomeInputPrincipal').value.trim();
            const v = parseInt(document.getElementById('novoVotosInputPrincipal').value, 10);
            const t = document.getElementById('novoContatoInputPrincipal').value.trim();
            if(!m || !lat || !n) return;
            const d = carregarTodosDados();
            const novo = { id: Date.now(), nome: n, votos: v, telefone: t };
            if (d[m]) d[m].lideres.push(novo); else d[m] = { lat, lon, lideres: [novo], dataVisita: null, notas: '' };
            salvarTodosDados(d);
            const w = "5513996476655"; const msg = encodeURIComponent(`CADASTRO DE NOVO LIDER\n\n*Munic√≠pio:* ${m}\n*L√≠der:* ${n}\n*Votos:* ${v}`); window.open(`https://wa.me/${w}?text=${msg}`, '_blank');
            redesenharMapaCompleto(); atualizarPlacarGeral(); atualizarPainelAgenda();
            addLiderModalPrincipal.classList.add('hidden');
            document.getElementById('municipioInputPrincipal').value=''; document.getElementById('latInputPrincipal').value=''; document.getElementById('lonInputPrincipal').value=''; document.getElementById('novoNomeInputPrincipal').value=''; document.getElementById('novoVotosInputPrincipal').value=''; document.getElementById('novoContatoInputPrincipal').value='';
        });
    </script>
</body>
</html>
