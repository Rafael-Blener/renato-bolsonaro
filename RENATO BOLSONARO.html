<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bolsonaro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        #map { height: 100vh; width: 100%; z-index: 0; }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background-color: white; color: #333; box-shadow: 0 3px 14px rgba(0,0,0,0.4); }
        .leaflet-popup-content p { margin: 0.5em 0; }
        .transition-opacity { transition: opacity 0.3s ease-in-out; }
        .modal-body { max-height: 60vh; overflow-y: auto; }
        
        .map-title-text {
            font-size: clamp(1.25rem, 3vw, 2.25rem);
        }
    </style>
</head>
<body class="font-sans bg-gray-100">

    <div id="app-content">
        <div id="map"></div>

        <div class="fixed top-4 left-1/2 -translate-x-1/2 bg-white bg-opacity-80 py-2 px-6 rounded-lg shadow-lg z-10 pointer-events-none w-11/12 max-w-md md:max-w-lg">
            <h1 class="map-title-text text-gray-800 font-bold text-center">
                BOLSONARO
            </h1>
        </div>

        <div id="placar-geral-caixa" class="fixed top-4 right-4 bg-white p-2 rounded-lg shadow-lg z-10 w-52">
            <h3 class="text-sm font-bold text-gray-800">Total de Votos</h3>
            <p id="total-votos-valor" class="text-xl font-bold text-blue-600 text-center">0</p>
            <div class="border-t my-1"></div>
            <h4 class="text-sm font-bold text-gray-800">Top 10 Líderes</h4>
            <ol id="ranking-lideres-lista" class="list-decimal list-inside space-y-1 text-xs">
                 </ol>
        </div>

        <button id="add-lider-btn-principal" class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-4 shadow-lg z-10" title="Adicionar Nova Liderança">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
        </button>
        
        <div id="add-lider-modal-principal" class="fixed inset-0 bg-black bg-opacity-50 z-20 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Cadastrar Nova Liderança</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Município</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <input type="text" id="municipioInputPrincipal" class="block w-full px-3 py-2 border rounded-md" placeholder="Ex: Santos">
                            <button id="geocode-btn-principal" class="px-4 py-2 bg-gray-600 text-white rounded-md">Buscar</button>
                        </div>
                        <p id="geocode-status-principal" class="text-xs text-gray-500 mt-1 h-4"></p>
                        <input type="hidden" id="latInputPrincipal"><input type="hidden" id="lonInputPrincipal">
                    </div>
                    <div class="border-t pt-4">
                        <label class="block text-sm font-medium text-gray-700">Nome do Líder</label>
                        <input type="text" id="novoNomeInputPrincipal" class="mt-1 block w-full px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Votos</label>
                        <input type="number" id="novoVotosInputPrincipal" class="mt-1 block w-full px-3 py-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Contato</label>
                        <input type="text" id="novoContatoInputPrincipal" class="mt-1 block w-full px-3 py-2 border rounded-md">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="cancel-lider-principal-btn" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                    <button id="save-lider-principal-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md">Salvar Liderança</button>
                </div>
            </div>
        </div>


        <div id="manage-lideres-modal" class="fixed inset-0 bg-black bg-opacity-50 z-30 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl">
                <h2 class="text-2xl font-bold mb-2 text-gray-800">Gerenciar Líderes em <span id="manage-modal-title" class="text-blue-600"></span></h2>
                
                <div id="lideres-list" class="space-y-3 mb-6 modal-body pr-2">
                    </div>

                <div class="border-t pt-4">
                    <h3 class="text-xl font-semibold mb-3 text-gray-700">Adicionar Novo Líder</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium">Nome do Líder</label>
                            <input type="text" id="add-lider-nome" class="mt-1 block w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Votos</label>
                            <input type="number" id="add-lider-votos" class="mt-1 block w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Contato</label>
                            <input type="text" id="add-lider-contato" class="mt-1 block w-full px-3 py-2 border rounded-md">
                        </div>
                    </div>
                     <button id="save-new-lider-btn" class="mt-4 w-full md:w-auto px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-md">Adicionar à Lista</button>
                </div>

                <div class="mt-6 flex justify-end">
                    <button id="close-manage-modal-btn" class="px-4 py-2 bg-gray-200 rounded-md">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            iniciarAplicacao();
        });

        function iniciarAplicacao() {
            const map = L.map('map').setView([-23.9, -47.7], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(map);

            const mapLayers = {};
            const DADOS_VOTOS_KEY = 'mapaBolsonaroDados_v1';
            let municipioEmGerenciamento = null;
            
            function inicializarDados() {
                const dadosSalvos = localStorage.getItem(DADOS_VOTOS_KEY);
                if (!dadosSalvos) { 
                    
                    const dadosIniciais = {
                        "Amparo": { lat: -22.70, lon: -46.76, lideres: [{ id: Date.now(), nome: "Paulo Rossi", telefone: "Contato não informado", votos: 36478 }] },
                        "Avaré": { lat: -23.09, lon: -48.92, lideres: [{ id: Date.now(), nome: "prefeito", telefone: "Contato não informado", votos: 41468 }] },
                        "Bauru": { lat: -22.31, lon: -49.06, lideres: [{ id: Date.now(), nome: "(Sem líder informado)", telefone: "Contato não informado", votos: 169278 }] },
                        "Bertioga": { lat: -23.85, lon: -46.13, lideres: [{ id: Date.now(), nome: "(Sem líder informado)", telefone: "Contato não informado", votos: 36318 }] },
                        "Boituva": { lat: -23.28, lon: -47.67, lideres: [{ id: Date.now(), nome: "(Sem líder informado)", telefone: "Contato não informado", votos: 31878 }] },
                        "Bragança Paulista": { lat: -22.95, lon: -46.54, lideres: [{ id: Date.now(), nome: "celamerico", telefone: "Contato não informado", votos: 88068 }] },
                        "Caraguatatuba": { lat: -23.62, lon: -45.41, lideres: [{ id: Date.now(), nome: "(Sem líder informado)", telefone: "Contato não informado", votos: 73388 }] },
                        "Cesário Lange": { lat: -23.22, lon: -47.95, lideres: [{ id: Date.now(), nome: "(Sem líder informado)", telefone: "Contato não informado", votos: 9938 }] },
                        "Ibitinga": { lat: -21.75, lon: -48.82, lideres: [{ id: Date.now(), nome: "Janaina", telefone: "Contato não informado", votos: 27856 }] },
                        "Ilhabela": { lat: -23.77, lon: -45.35, lideres: [{ id: Date.now(), nome: "(Sem líder informado)", telefone: "Contato não informado", votos: 23356 }] },
                        "Indaiatuba": { lat: -23.09, lon: -47.21, lideres: [{ id: Date.now(), nome: "(Sem líder informado)", telefone: "Contato não informado", votos: 125473 }] },
                        "Itapecerica da Serra": { lat: -23.71, lon: -46.84, lideres: [{ id: Date.now(), nome: "sangue bom,j", telefone: "Contato não informado", votos: 87877 }] },
                        "Itu": { lat: -23.26, lon: -47.29, lideres: [{ id: Date.now(), nome: "(Sem líder informado)", telefone: "Contato não informado", votos: 82739 }] },
                        "Leme": { lat: -22.18, lon: -47.38, lideres: [{ id: Date.now(), nome: "Vereadora An", telefone: "Contato não informado", votos: 48878 }] },
                        "Mogi Guaçu": { lat: -22.37, lon: -46.94, lideres: [{ id: Date.now(), nome: "polentini", telefone: "Contato não informado", votos: 77224 }] },
                        "Olímpia": { lat: -20.73, lon: -48.91, lideres: [{ id: Date.now(), nome: "tarcisio", telefone: "Contato não informado", votos: 29899 }] },
                        "Palmeira d'Oeste": { lat: -20.16, lon: -50.81, lideres: [{ id: Date.now(), nome: "prefeito valdir", telefone: "Contato não informado", votos: 5537 }] },
                        "Panorama": { lat: -21.35, lon: -51.85, lideres: [{ id: Date.now(), nome: "Eneas", telefone: "Contato não informado", votos: 7770 }] },
                        "Piracicaba": { lat: -22.72, lon: -47.64, lideres: [{ id: Date.now(), nome: "(Sem líder informado)", telefone: "Contato não informado", votos: 198468 }] },
                        "Rio das Pedras": { lat: -22.84, lon: -47.60, lideres: [{ id: Date.now(), nome: "Prefeito / Vere", telefone: "Contato não informado", votos: 19034 }] },
                        "Santa Fé do Sul": { lat: -20.21, lon: -50.92, lideres: [{ id: Date.now(), nome: "Vereador Mur", telefone: "Contato não informado", votos: 17745 }] },
                        "São Sebastião": { lat: -23.76, lon: -45.40, lideres: [{ id: Date.now(), nome: "(Sem líder informado)", telefone: "Contato não informado", votos: 51303 }] },
                        "Ubatuba": { lat: -23.43, lon: -45.07, lideres: [{ id: Date.now(), nome: "(Sem líder informado)", telefone: "Contato não informado", votos: 52682 }] }
                    };

                    localStorage.setItem(DADOS_VOTOS_KEY, JSON.stringify(dadosIniciais));
                }
            }

            function carregarTodosDados() { return JSON.parse(localStorage.getItem(DADOS_VOTOS_KEY) || '{}'); }
            function salvarTodosDados(dados) { localStorage.setItem(DADOS_VOTOS_KEY, JSON.stringify(dados)); }
            
            function carregarDadosMunicipio(municipioNome) {
                const todosDados = carregarTodosDados();
                return todosDados[municipioNome] || { lat: 0, lon: 0, lideres: [] };
            }
            
            function calcularVotosTotaisMunicipio(dadosMunicipio) {
                return dadosMunicipio.lideres.reduce((acc, lider) => acc + (parseInt(lider.votos, 10) || 0), 0);
            }

            // --- FUNÇÕES DO PLACAR GERAL ---
            function calcularTotalGeralDeVotos() {
                const todosDados = carregarTodosDados();
                let totalGeral = 0;
                for (const municipioNome in todosDados) {
                    totalGeral += calcularVotosTotaisMunicipio(todosDados[municipioNome]);
                }
                return totalGeral;
            }

            function calcularTopLideres() {
                const todosDados = carregarTodosDados();
                const todosLideres = [];
                for (const municipioNome in todosDados) {
                    todosDados[municipioNome].lideres.forEach(lider => {
                        todosLideres.push({ ...lider, municipio: municipioNome });
                    });
                }
                todosLideres.sort((a, b) => (b.votos || 0) - (a.votos || 0));
                return todosLideres.slice(0, 10); 
            }

            function atualizarPlacarGeral() {
                const total = calcularTotalGeralDeVotos();
                document.getElementById('total-votos-valor').textContent = total.toLocaleString('pt-BR');

                const topLideres = calcularTopLideres();
                const listaEl = document.getElementById('ranking-lideres-lista');
                listaEl.innerHTML = ''; 

                if (topLideres.length === 0) {
                    listaEl.innerHTML = '<li class="text-gray-500">Nenhum líder.</li>';
                    return;
                }

                topLideres.forEach(lider => {
                    const item = document.createElement('li');
                    item.className = "truncate"; 
                    item.innerHTML = `
                        <span class="font-semibold">${lider.nome}</span> (${(lider.votos || 0).toLocaleString('pt-BR')})
                        <span class="block text-gray-500 -mt-1">${lider.municipio}</span>
                    `;
                    listaEl.appendChild(item);
                });
            }

            // --- FUNÇÕES DE VISUALIZAÇÃO NO MAPA ---
            
            function calcularRaio(votos) { return votos > 0 ? Math.sqrt(votos) * 24 : 0; }

            function desenharCirculoNoMapa(municipioNome, dados) {
                if (mapLayers[municipioNome]) map.removeLayer(mapLayers[municipioNome]);
                
                const votosTotais = calcularVotosTotaisMunicipio(dados);
                
                // ***** MUDANÇAS FEITAS AQUI *****
                const circle = L.circle([dados.lat, dados.lon], {
                    color: '#FF0000',      // Cor da borda (Vermelho)
                    opacity: 1.0,           // Opacidade da borda (Sólida)
                    weight: 1.5,            // Aumentei um pouco a espessura da borda
                    fillColor: '#7FFF00',   // Cor do preenchimento (Verde-Limão)
                    fillOpacity: 0.5,       // Opacidade do preenchimento
                    radius: calcularRaio(votosTotais)
                }).addTo(map);

                circle.bindPopup(() => criarConteudoPopup(municipioNome));
                mapLayers[municipioNome] = circle;
            }

            function redesenharMapaCompleto() {
                Object.values(mapLayers).forEach(layer => map.removeLayer(layer));
                const todosDados = carregarTodosDados();
                for (const nomeMunicipio in todosDados) {
                    desenharCirculoNoMapa(nomeMunicipio, todosDados[nomeMunicipio]);
                }
            }
            
            function atualizarVisualizacaoMunicipio(municipioNome) {
                const dados = carregarDadosMunicipio(municipioNome);
                desenharCirculoNoMapa(municipioNome, dados);
                atualizarPlacarGeral();
            }

            // --- FUNÇÕES DE CONTEÚDO E INTERAÇÃO ---
            function criarConteudoPopup(municipioNome) {
                const dados = carregarDadosMunicipio(municipioNome);
                const votosTotais = calcularVotosTotaisMunicipio(dados);
                let lideresHtml = dados.lideres.map(lider => {
                    const numeroLimpo = (lider.telefone || '').replace(/\D/g, '');
                    const temWhatsapp = numeroLimpo.length > 8; 
                    
                    return `
                    <div class="border-t mt-2 pt-2">
                        <p><strong>Líder:</strong> ${lider.nome}</p>
                        <p><strong>Votos:</strong> ${(lider.votos || 0).toLocaleString('pt-BR')}</p>
                        <div class="flex items-center justify-between">
                            <p><strong>Contato:</strong> ${lider.telefone}</p>
                            ${temWhatsapp ? `
                            <a href="https://wa.me/55${numeroLimpo}" target="_blank" title="Abrir no WhatsApp" class="p-1 rounded-full hover:bg-green-100 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
                                </svg>
                            </a>` : ''}
                        </div>
                    </div>`;
                }).join('');

                if (dados.lideres.length === 0) lideresHtml = '<p>Nenhum líder cadastrado.</p>';

                return `
                    <div class="p-1" style="max-width: 280px">
                        <h3 class="text-lg font-bold text-gray-800">${municipioNome}</h3>
                        <p class="font-semibold text-blue-600">Total de Votos: ${votosTotais.toLocaleString('pt-BR')}</p>
                        ${lideresHtml}
                        <button onclick="abrirModalGerenciamento('${municipioNome}')" class="mt-3 w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded">
                            Gerenciar Líderes
                        </button>
                    </div>
                `;
            }

            window.abrirModalGerenciamento = (municipioNome) => {
                municipioEmGerenciamento = municipioNome;
                document.getElementById('manage-modal-title').textContent = municipioNome;
                renderizarListaLideres(municipioNome);
                document.getElementById('manage-lideres-modal').classList.remove('hidden');
            };

            function renderizarListaLideres(municipioNome) {
                const dados = carregarDadosMunicipio(municipioNome);
                const listaEl = document.getElementById('lideres-list');
                listaEl.innerHTML = ''; 

                if (dados.lideres.length === 0) {
                    listaEl.innerHTML = '<p class="text-gray-500 text-center">Nenhum líder cadastrado para este município.</p>';
                    return;
                }

                dados.lideres.forEach(lider => {
                    const item = document.createElement('div');
                    item.className = 'bg-gray-100 p-3 rounded-md flex flex-wrap items-center justify-between';
                    item.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold">${lider.nome}</p>
                            <p class="text-sm text-gray-600">Votos: ${(lider.votos || 0).toLocaleString('pt-BR')} | Contato: ${lider.telefone}</p>
                        </div>
                        <button onclick="removerLider('${municipioNome}', ${lider.id})" class="ml-4 px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs font-bold rounded">Remover</button>
                    `;
                    listaEl.appendChild(item);
                });
            }
            
            window.removerLider = (municipioNome, liderId) => {
                if (!confirm(`Tem certeza que deseja remover este líder?`)) return;

                const todosDados = carregarTodosDados();
                const dadosMunicipio = todosDados[municipioNome];
                dadosMunicipio.lideres = dadosMunicipio.lideres.filter(l => l.id !== liderId);
                salvarTodosDados(todosDados);
                
                renderizarListaLideres(municipioNome);
                atualizarVisualizacaoMunicipio(municipioNome);
            };

            // --- LÓGICA DOS MODAIS ---
            
            // Modal de Gerenciamento
            document.getElementById('close-manage-modal-btn').addEventListener('click', () => {
                document.getElementById('manage-lideres-modal').classList.add('hidden');
                municipioEmGerenciamento = null;
            });

            document.getElementById('save-new-lider-btn').addEventListener('click', () => {
                const nome = document.getElementById('add-lider-nome').value.trim();
                const votosInput = document.getElementById('add-lider-votos').value.trim();
                const telefone = document.getElementById('add-lider-contato').value.trim();

                if (!nome || !votosInput || !telefone) {
                    alert('Todos os campos (Nome, Votos e Contato) são obrigatórios para continuar.');
                    return;
                }
                
                const votos = parseInt(votosInput, 10);
                if (isNaN(votos)) {
                    alert('O campo "Votos" deve conter um número válido.');
                    return;
                }
                
                const whatsappNumber = "5513996476655"; 
                const titulo = "CADASTRO DE NOVO LIDER";
                const mensagem = `${titulo}\n\n*Município:* ${municipioEmGerenciamento}\n*Novo Líder:* ${nome}\n*Votos:* ${votos}\n*Contato:* ${telefone}`;
                const mensagemCodificada = encodeURIComponent(mensagem);
                const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${mensagemCodificada}`;
                window.open(whatsappUrl, '_blank');

                const todosDados = carregarTodosDados();
                const dadosMunicipio = todosDados[municipioEmGerenciamento];
                dadosMunicipio.lideres.push({ id: Date.now(), nome, votos, telefone });
                salvarTodosDados(todosDados);

                document.getElementById('add-lider-nome').value = '';
                document.getElementById('add-lider-votos').value = '';
                document.getElementById('add-lider-contato').value = '';
                renderizarListaLideres(municipioEmGerenciamento);
                atualizarVisualizacaoMunicipio(municipioEmGerenciamento);
            });
            
            // Modal de Cadastro Principal
            const addLiderModalPrincipal = document.getElementById('add-lider-modal-principal');
            document.getElementById('add-lider-btn-principal').addEventListener('click', () => addLiderModalPrincipal.classList.remove('hidden'));
            document.getElementById('cancel-lider-principal-btn').addEventListener('click', () => addLiderModalPrincipal.classList.add('hidden'));

            document.getElementById('geocode-btn-principal').addEventListener('click', async () => {
                const municipioNome = document.getElementById('municipioInputPrincipal').value;
                const statusEl = document.getElementById('geocode-status-principal');
                statusEl.textContent = 'Buscando...';
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(municipioNome)}, Brasil`);
                    const data = await response.json();
                    if (data && data.length > 0) {
                        document.getElementById('latInputPrincipal').value = data[0].lat;
                        document.getElementById('lonInputPrincipal').value = data[0].lon;
                        statusEl.textContent = `Coordenadas encontradas!`;
                    } else { statusEl.textContent = 'Município não encontrado.'; }
                } catch (error) { statusEl.textContent = 'Erro ao buscar.'; }
            });

            document.getElementById('save-lider-principal-btn').addEventListener('click', () => {
                const municipioNome = document.getElementById('municipioInputPrincipal').value.trim();
                const lat = parseFloat(document.getElementById('latInputPrincipal').value);
                const lon = parseFloat(document.getElementById('lonInputPrincipal').value);
                const liderNome = document.getElementById('novoNomeInputPrincipal').value.trim();
                const votos = parseInt(document.getElementById('novoVotosInputPrincipal').value, 10) || 0;
                const contato = document.getElementById('novoContatoInputPrincipal').value.trim();

                if (!municipioNome || !lat || !lon || !liderNome || !contato) {
                    alert('Preencha todos os campos e busque as coordenadas antes de salvar.');
                    return;
                }

                // Envia para o WhatsApp
                const whatsappNumber = "5513996476655"; 
                const titulo = "CADASTRO DE NOVO LIDER";
                const mensagem = `${titulo}\n\n*Município:* ${municipioNome}\n*Novo Líder:* ${liderNome}\n*Votos:* ${votos}\n*Contato:* ${contato}`;
                const mensagemCodificada = encodeURIComponent(mensagem);
                const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${mensagemCodificada}`;
                window.open(whatsappUrl, '_blank');

                const todosDados = carregarTodosDados();
                const novoLider = { id: Date.now(), nome: liderNome, votos: votos, telefone: contato };

                if (todosDados[municipioNome]) {
                    todosDados[municipioNome].lideres.push(novoLider);
                } else {
                    todosDados[municipioNome] = { lat, lon, lideres: [novoLider] };
                }

                salvarTodosDados(todosDados);
                atualizarVisualizacaoMunicipio(municipioNome);
                
                // Limpa e fecha o modal
                document.getElementById('municipioInputPrincipal').value = '';
                document.getElementById('latInputPrincipal').value = '';
                document.getElementById('lonInputPrincipal').value = '';
                document.getElementById('novoNomeInputPrincipal').value = '';
                document.getElementById('novoVotosInputPrincipal').value = '';
                document.getElementById('novoContatoInputPrincipal').value = '';
                document.getElementById('geocode-status-principal').textContent = '';
                addLiderModalPrincipal.classList.add('hidden');
            });

            // --- INICIALIZAÇÃO DO APLICATIVO ---
            inicializarDados();
            redesenharMapaCompleto();
            atualizarPlacarGeral(); 
        }
    </script>
</body>
</html>